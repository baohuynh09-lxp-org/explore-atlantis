version: 3
projects:
  - &template_project
    apply_requirements: [mergeable] #Requirements that must be satisfied before atlantis apply can be run
    workflow: awsWorkflow
    dir: deployment/
    autoplan:                                                     
      enabled: false

  #- &template_jumphost
  #  apply_requirements: [mergeable] #Requirements that must be satisfied before atlantis apply can be run
  #  workflow: awsWorkflow
  #  dir: deployment/
  #  autoplan:                                                     
  #    enabled: false
#
  #- &template_eks
  #  apply_requirements: [mergeable] #Requirements that must be satisfied before atlantis apply can be run
  #  workflow: awsWorkflow
  #  dir: deployment/
  #  autoplan:                                                     
  #    enabled: false
#
  #- &template_database
  #  apply_requirements: [mergeable] #Requirements that must be satisfied before atlantis apply can be run
  #  workflow: awsWorkflow
  #  dir: deployment/
  #  autoplan:                                                     
  #    enabled: false

  #---------------------------#
  #       dev-sandbox         #
  #---------------------------#
  -
    <<: *template_project
    name: dev-sandbox_network
  -
    <<: *template_project
    name: dev-sandbox_jumphost
  -
    <<: *template_project
    name: dev-sandbox_eks
  -
    <<: *template_project
    name: dev-sandbox_database


  #---------------------------#
  #       macquarie-uat       #
  #---------------------------#
  -
    <<: *template_project
    name: macquarie-uat_network
  -
    <<: *template_project
    name: macquarie-uat_jumphost
  -
    <<: *template_project
    name: macquarie-uat_eks
  -
    <<: *template_project
    name: macquarie-uat_database

  #- name: dev-sandbox_network
  #  dir: deployment/network
  #  workflow: network
  #  apply_requirements: [mergeable] 
  #  autoplan:
  #    enabled: false
  #
  #- name: dev-sandbox_jumphost
  #  dir: deployment/jumphost
  #  workflow: jumphost
  #  apply_requirements: [mergeable] #Requirements that must be satisfied before atlantis apply can be run
  #  autoplan:
  #    enabled: false

workflows:
  awsWorkflow:
    plan:
      steps:
      - env:   # extract saas environment name
          name: ENV
          command: "echo $PROJECT_NAME | awk -F'_' '{print $1}'"
          name: COMPONENT
          command: "echo $PROJECT_NAME | awk -F'_' '{print $2}'"
      
      - run: | # prepare TF configuration files
          rm -rf .terraform
          cp ./variables.tf $COMPONENT

      - run: | # terraform init
          echo "ENV_init: $ENV";
          terraform init -backend-config=env/backends/${ENV}.backend.tf

      - run: | # terraform plan
          terraform plan -target=module.${COMPONENT} \
                         -var-file=env/input-tfvars/${ENV}.tfvars \
                         -input=false \
                         -out $PLANFILE
    apply:
      steps:
      - run: | # terraform apply
          echo "PLANFILE: $PLANFILE"
          terraform apply $PLANFILE

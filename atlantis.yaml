version: 3
projects:
- name: dev-sandbox_network
  dir: deployment/network
  workflow: network
  apply_requirements: [mergeable] #Requirements that must be satisfied before atlantis apply can be run
  autoplan:
    enabled: false

- name: dev-sandbox_jumphost
  dir: deployment/jumphost
  workflow: jumphost
  apply_requirements: [mergeable] #Requirements that must be satisfied before atlantis apply can be run
  autoplan:
    enabled: false

workflows:
  network:
    plan:
      steps:
      - env:
          name: ENV
          command: "echo $PROJECT_NAME | awk -F'_' '{print $1}'"
      - run: |
          rm -rf .terraform
          cp     ../common/* ./
          echo "ENV_init: $ENV";
          terraform init -backend-config=../backends/${ENV}.backend.tf

      #    #TF_ARG=$(echo $COMMENT_ARGS | tr ',' ' ' | sed -r 's/\\(.)/\1/g')
      #    #echo "TF_ARG: $TF_ARG"
      #    TEST1=$(printf '%b\n' "$COMMENT_ARGS")
      #    echo "COMMENT_ARGS: $COMMENT_ARGS"
      #    echo "TEST1: $TEST1"

      #- run: |
      #    echo "ENV_plan: $ENV";
      #    terraform plan -var-file=../env/${ENV}.tfvars \
      #                         -input=false \
      #                         -out $PLANFILE

      #- init:
      #    extra_args: [-backend-config=backends/dev-sandbox.backend.tf]
      #- run: |
      #    terraform plan -var-file=../env/dev-sandbox.tfvars -input=false -out $PLANFILE
      #    echo "PLANFILE: $PLANFILE"
      #    ls $PLANFILE
      #- plan:
      #    extra_args: [-var-file=../env/dev-sandbox.tfvars -input=false -refresh -out $PLANFILE]

      

    apply:
      steps:
      ##- run: |
      ##    rm -rf .terraform 
      #- init:
      #    extra_args: [-backend-config=backends/dev-sandbox.backend.tf]
      - run: |
          echo "PLANFILE: $PLANFILE"
          ls $PLANFILE
          terraform apply $PLANFILE


  jumphost:
    plan:
      steps:
      - run: |
          rm -rf .terraform
          echo "COMMENT_ARGS: $COMMENT_ARGS"
      - init:
          extra_args: [-backend-config=../backends/dev-sandbox.backend.tf]
      - plan:
          extra_args: [-var-file=../env/dev-sandbox.tfvars]

    apply:
      steps:
      - run: |
          rm -rf .terraform
          echo "COMMENT_ARGS:# $COMMENT_ARGS"
      - init:
          extra_args: [-backend-config=../backends/dev-sandbox.backend.tf]
      - plan:
          extra_args: [-var-file=../env/dev-sandbox.tfvars]
